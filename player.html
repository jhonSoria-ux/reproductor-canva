<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Audio Player</title>

    <!-- METADATOS OPTIMIZADOS PARA EL REPRODUCTOR -->
    <meta name="twitter:card" content="player">
    <meta name="twitter:site" content="@AudioStudioPro">
    <meta name="twitter:title" content="Audio Player">
    <meta name="twitter:description" content="Reproducir Audio">
    <meta name="twitter:player:width" content="800">
    <meta name="twitter:player:height" content="400">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        :root { --primary: #00c4cc; --canvas-bg: #0f172a; }

        /* MODO PLAYER PURO: Fondo transparente para integrarse en Canva */
        body { 
            margin: 0; 
            overflow: hidden; 
            background-color: transparent; 
            display: flex; 
            align-items: center; 
            justify-content: center;
            height: 100vh;
            width: 100vw;
            opacity: 0; 
            transition: opacity 0.5s ease;
        }
        body.is-ready { opacity: 1; }

        .mica-layer {
            backdrop-filter: blur(40px) saturate(250%) contrast(110%) brightness(110%);
            -webkit-backdrop-filter: blur(40px) saturate(250%) contrast(110%) brightness(110%);
            border: 1.2px solid rgba(255, 255, 255, 0.35);
            box-shadow: 0 30px 70px -15px rgba(0, 0, 0, 0.6);
        }

        /* En el player, los elementos NO se mueven, pero el botón SÍ recibe clicks */
        .draggable { position: absolute; z-index: 50; pointer-events: none; }
        #drag-play { pointer-events: auto; cursor: pointer; }
        #play-btn-main {
            display: flex; align-items: center; justify-content: center;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); position: relative;
        }
        #play-btn-main:active { transform: scale(0.95); }

        #play-btn-contour {
            position: absolute; inset: -8px; border-radius: inherit;
            border: var(--contour-width, 3px) solid var(--contour-color, rgba(255,255,255,0.4));
            pointer-events: none; transition: all 0.3s ease;
        }

        /* Tipografías */
        .font-sans { font-family: ui-sans-serif, system-ui, sans-serif; }
        .font-serif { font-family: ui-serif, Georgia, serif; }
        .font-mono { font-family: ui-monospace, SFMono-Regular, monospace; }
        .font-impact { font-family: 'Arial Black', sans-serif; font-weight: 900; }

        @keyframes pulse-wave { 0% { opacity: 0.4; filter: brightness(1); } 50% { opacity: 1; filter: brightness(1.5); } 100% { opacity: 0.4; filter: brightness(1); } }
        .wave-active { animation: pulse-wave 1.2s infinite ease-in-out; }

        #player-master { width: 460px; height: 150px; display: block; position: relative; }
        
        /* Loader minimalista */
        #loader { 
            position: fixed; inset: 0; background: #0f172a; z-index: 9999;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            color: white; transition: opacity 0.5s ease;
        }
    </style>
</head>
<body>

    <div id="loader">
        <div class="w-12 h-12 border-4 border-slate-700 border-t-cyan-400 rounded-full animate-spin"></div>
    </div>

    <!-- EL REPRODUCTOR (Copia exacta de tu diseño) -->
    <div id="player-master" class="relative overflow-hidden shadow-2xl">
        <div id="spect-layer" class="absolute inset-0 opacity-40 z-0 pointer-events-none hidden">
            <div class="w-full h-full"><canvas id="audioChart"></canvas></div>
        </div>

        <div id="elements-container" class="relative z-10 w-full h-full">
            <div id="drag-play" class="draggable" style="top: 35px; left: 35px;">
                <button onclick="window.toggleAudio()" id="play-btn-main" class="w-20 h-20 shadow-2xl">
                    <div id="play-btn-contour"></div>
                    <svg width="34" height="34" viewBox="0 0 24 24" fill="currentColor"><path id="path-icon" d="M8 5V19L19 12L8 5Z" /></svg>
                </button>
            </div>
            
            <div id="drag-text" class="draggable" style="top: 35px; left: 140px; width: 280px;">
                <h3 id="ui-title" class="text-2xl font-black leading-none truncate mb-1 text-white">...</h3>
                <p id="ui-subtitle" class="text-[11px] font-black opacity-60 uppercase tracking-widest truncate text-slate-400">...</p>
            </div>

            <div id="drag-progress" class="draggable" style="top: 100px; left: 140px; width: 280px;">
                <div id="progress-ui" class="w-full bg-white/15 rounded-full overflow-hidden relative">
                    <div id="progress-fill" class="h-full transition-all duration-300" style="width: 0%"></div>
                    <div id="progress-wave" class="absolute inset-0 hidden"><div class="h-full w-full" id="wave-pulse-overlay"></div></div>
                </div>
                <div id="timer-group" class="flex justify-between mt-2 text-[11px] font-black opacity-90 tracking-tighter text-white">
                    <span id="ui-now">00:00</span>
                    <span id="ui-total">00:00</span>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js';
        import { getFirestore, doc, getDoc } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';
        import { getAuth, signInAnonymously } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';

        const firebaseConfig = { apiKey: "AIzaSyBWelUwvZAdKlS4ks7MlL-ALP4f3A0ok88", authDomain: "audiostudiopro-a876a.firebaseapp.com", projectId: "audiostudiopro-a876a", storageBucket: "audiostudiopro-a876a.firebasestorage.app", messagingSenderId: "618218270805", appId: "1:618218270805:web:7c4e63066a770cf095e4dc", measurementId: "G-EE97PW6QZL" };
        
        // Variables
        let db, auth;
        let audioUrl = "";
        let audio = new Audio();
        let isPlaying = false;
        let activeProgStyle = 'bar';
        let chart;

        // Inicializar SOLO reproducción
        async function initPlayer() {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                await signInAnonymously(auth);

                const urlParams = new URLSearchParams(window.location.search);
                const id = urlParams.get('id');

                if (id) {
                    loadDesign(id);
                } else {
                    document.getElementById('loader').style.display = 'none'; // Mostrar vacío si no hay ID
                    document.body.classList.add('is-ready');
                }
            } catch (e) { console.error(e); }
        }

        async function loadDesign(id) {
            try {
                const docRef = doc(db, 'artifacts', 'audio-studio-pro', 'public', 'data', 'designs', id);
                const snap = await getDoc(docRef);
                if (snap.exists()) {
                    renderUI(snap.data());
                }
            } catch (e) { console.error(e); }
            
            // Ocultar loader suavemente
            const l = document.getElementById('loader');
            l.style.opacity = '0';
            setTimeout(() => { l.style.display = 'none'; document.body.classList.add('is-ready'); }, 500);
        }

        function renderUI(d) {
            const get = (id) => document.getElementById(id);
            const master = get('player-master');
            
            // 1. Estructura y Fondo
            master.style.width = d.w + 'px'; master.style.height = d.h + 'px';
            master.style.borderRadius = (d.rdMain || 24) + 'px';
            master.style.backgroundColor = hexToRgba(d.bg, d.op / 100);
            if (d.showMica) master.classList.add('mica-layer');
            else master.classList.remove('mica-layer');

            // 2. Botón Play
            const btn = get('play-btn-main'); const contour = get('play-btn-contour');
            btn.style.color = d.btnTri; btn.style.backgroundColor = d.btnBg;
            btn.style.borderRadius = d.rdBtn + '%';
            contour.style.borderColor = d.showContour ? d.btnContour : 'transparent';
            contour.style.borderRadius = d.rdBtn + '%';

            // 3. Textos y Fuentes
            const title = get('ui-title'); const sub = get('ui-subtitle'); const timer = get('timer-group');
            title.innerText = decodeURIComponent(d.title || ''); title.style.color = d.textCol;
            sub.innerText = decodeURIComponent(d.artist || ''); sub.style.color = d.subCol;
            timer.style.color = d.progTextCol;
            
            // Clases de fuente
            const fontContainer = get('drag-text');
            fontContainer.className = `draggable ${d.fontType}`;
            timer.className = `flex justify-between mt-2 text-[11px] font-black opacity-90 tracking-tighter ${d.fontProg}`;

            // 4. Progreso (Estilo)
            activeProgStyle = d.progStyle || 'bar';
            const bar = get('progress-ui'); const fill = get('progress-fill');
            bar.style.height = d.barH + 'px';
            fill.style.backgroundColor = d.barAcc;
            
            // Lógica visualizador
            const wave = get('progress-wave'); const spect = get('spect-layer');
            const wavePulse = get('wave-pulse-overlay');
            
            wave.classList.add('hidden'); spect.classList.add('hidden'); // Reset
            if (activeProgStyle === 'wave') {
                wave.classList.remove('hidden');
                wavePulse.style.backgroundColor = d.barAcc;
                wavePulse.classList.add('wave-active');
            } else if (activeProgStyle === 'spect') {
                spect.classList.remove('hidden');
            }

            // 5. Posiciones
            if(d.m1) pos('drag-play', d.m1);
            if(d.m2) pos('drag-text', d.m2);
            if(d.m3) pos('drag-progress', d.m3);

            // 6. Audio
            audioUrl = d.url;
            // Procesar URL si es necesario (Drive/Dropbox/Vocaroo)
            audioUrl = processUrl(audioUrl);
        }

        function pos(id, coords) {
            const el = document.getElementById(id);
            if(el) { el.style.left = coords.x + '%'; el.style.top = coords.y + '%'; }
        }

        function hexToRgba(hex, a) {
            let r = parseInt(hex.slice(1, 3), 16), g = parseInt(hex.slice(3, 5), 16), b = parseInt(hex.slice(5, 7), 16);
            return `rgba(${r}, ${g}, ${b}, ${a})`;
        }

        // --- LÓGICA DE AUDIO Y ENLACES ---
        function processUrl(url) {
            if (!url) return "";
            url = url.trim();
            
            // Vocaroo
            if (url.includes('vocaroo.com')) {
                const parts = url.split('/');
                const id = parts[parts.length - 1];
                if (id) return `https://media.vocaroo.com/mp3/${id}`;
            }
            // Google Drive
            if (url.includes('drive.google.com')) {
                const match = url.match(/\/d\/(.+?)\//) || url.match(/id=(.+?)(&|$)/);
                if (match && match[1]) return `https://docs.google.com/uc?export=download&id=${match[1]}`;
            }
            // Dropbox
            if (url.includes('dropbox.com') && url.includes('dl=0')) {
                return url.replace('dl=0', 'dl=1');
            }
            return url;
        }

        window.toggleAudio = () => {
            if (!audioUrl) return;
            if (audio.src !== audioUrl) { audio.src = audioUrl; audio.crossOrigin = "anonymous"; }

            const path = document.getElementById('path-icon');
            if (audio.paused) {
                audio.play().then(() => {
                    isPlaying = true; 
                    path.setAttribute('d', 'M6 19h4V5H6v14zm8-14v14h4V5h-4z'); // Icono Pause
                    renderLoop();
                }).catch(e => console.error("Error play:", e));
            } else { 
                audio.pause(); 
                isPlaying = false; 
                path.setAttribute('d', 'M8 5V19L19 12L8 5Z'); // Icono Play
            }
        };

        function renderLoop() {
            if (!isPlaying) return;
            
            // Animación Espectro Fake (Visual)
            if (chart && activeProgStyle === 'spect') { 
                chart.data.datasets[0].data = chart.data.datasets[0].data.map(() => Math.random() * 100); 
                chart.update(); 
            }

            // Barra Progreso
            if (audio.duration) {
                const pct = (audio.currentTime / audio.duration) * 100;
                document.getElementById('progress-fill').style.width = pct + '%';
                
                const f = (t) => { 
                    const m = Math.floor(t/60), s = Math.floor(t%60); 
                    return `${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`; 
                };
                document.getElementById('ui-now').innerText = f(audio.currentTime);
                document.getElementById('ui-total').innerText = f(audio.duration);
            }
            requestAnimationFrame(renderLoop);
        }

        // Setup Chart
        window.onload = () => { 
            const c = document.getElementById('audioChart'); 
            if(c) { 
                const ctx = c.getContext('2d'); 
                chart = new Chart(ctx, { 
                    type: 'bar', 
                    data: { labels: Array(22).fill(''), datasets: [{ data: Array(22).fill(0), backgroundColor: '#00c4cc', borderRadius: 20 }] }, 
                    options: { responsive: true, maintainAspectRatio: false, scales: { y: { display: false, min:0, max:100 }, x: { display: false } }, plugins: { legend: false }, animation: false } 
                }); 
            }
            initPlayer();
        };
    </script>
</body>
</html>
