<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Audio Studio Pro - Architect Edition v5</title>
    
    <!-- === ESTRATEGIA DEFINITIVA TIPO VOCAROO === -->
    <meta name="twitter:card" content="player">
    <meta name="twitter:site" content="@AudioStudioPro">
    <meta name="twitter:title" content="Audio Studio Pro Player">
    <meta name="twitter:description" content="Reproductor de Audio Interactivo">
    <!-- IMPORTANTE: El player debe apuntar a la ra√≠z, Canva a√±adir√° los par√°metros -->
    <meta name="twitter:player" content="https://reproductor-canva.vercel.app/">
    <meta name="twitter:player:width" content="800">
    <meta name="twitter:player:height" content="400">
    <meta name="twitter:image" content="https://reproductor-canva.vercel.app/preview.png">

    <meta property="og:title" content="Audio Studio Pro Player">
    <meta property="og:description" content="Click para reproducir audio.">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://reproductor-canva.vercel.app/">
    <meta property="og:image" content="https://reproductor-canva.vercel.app/preview.png">
    
    <link rel="alternate" type="application/json+oembed" href="oembed.json" title="Audio Studio Pro Player">

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

    <style>
        :root { --primary: #00c4cc; --canvas-bg: #0f172a; }

        /* ELIMINAR DESORDEN INICIAL */
        body.is-loading #player-master { opacity: 0; }
        body.is-ready #player-master { opacity: 1; transition: opacity 0.5s ease; }

        .canvas-area {
            background-color: var(--canvas-bg);
            background-image: linear-gradient(rgba(255, 255, 255, 0.1) 1.5px, transparent 1.5px),
                              linear-gradient(90deg, rgba(255, 255, 255, 0.1) 1.5px, transparent 1.5px);
            background-size: 30px 30px; position: relative;
        }

        .mica-layer {
            backdrop-filter: blur(40px) saturate(250%) contrast(110%) brightness(110%);
            -webkit-backdrop-filter: blur(40px) saturate(250%) contrast(110%) brightness(110%);
            border: 1.2px solid rgba(255, 255, 255, 0.35);
            box-shadow: 0 30px 70px -15px rgba(0, 0, 0, 0.6);
        }

        .sidebar-tab-content { display: none; }
        .sidebar-tab-content.active { display: block; }

        .draggable { 
            cursor: move; user-select: none; position: absolute; z-index: 50; 
            transition: outline 0.2s, transform 0.1s;
        }
        /* Desactivar hover en modo embed para limpieza visual */
        body.is-embedded .draggable { cursor: default; }
        .draggable:hover:not(body.is-embedded .draggable) { outline: 2px dashed var(--primary); outline-offset: 14px; }
        .draggable:active:not(body.is-embedded .draggable) { cursor: grabbing; transform: scale(1.05); }

        #play-btn-main {
            display: flex; align-items: center; justify-content: center;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); position: relative;
        }

        #play-btn-contour {
            position: absolute; inset: -8px; border-radius: inherit;
            border: var(--contour-width, 3px) solid var(--contour-color, rgba(255,255,255,0.4));
            pointer-events: none; transition: all 0.3s ease;
        }

        .font-sans { font-family: ui-sans-serif, system-ui, sans-serif; }
        .font-serif { font-family: ui-serif, Georgia, serif; }
        .font-mono { font-family: ui-monospace, SFMono-Regular, monospace; }
        .font-impact { font-family: 'Arial Black', sans-serif; font-weight: 900; }

        #loader { background: #0f172a; transition: opacity 0.5s ease; z-index: 9999; }
        
        input[type="range"] { -webkit-appearance: none; background: #cbd5e1; height: 6px; border-radius: 10px; }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none; height: 20px; width: 20px; background: var(--primary);
            border-radius: 50%; cursor: pointer; box-shadow: 0 0 15px rgba(0,196,204,0.4); border: 2px solid white;
        }

        @keyframes pulse-wave { 0% { opacity: 0.4; filter: brightness(1); } 50% { opacity: 1; filter: brightness(1.5); } 100% { opacity: 0.4; filter: brightness(1); } }
        .wave-active { animation: pulse-wave 1.2s infinite ease-in-out; }

        #player-master { width: 460px; height: 150px; min-width: 200px; min-height: 80px; display: block; position: relative; }

        /* AJUSTES PARA EMBED (MODO CANVA) */
        body.is-embedded { background: transparent !important; }
        body.is-embedded #editor-sidebar, body.is-embedded #workspace-label { display: none !important; }
        body.is-embedded .canvas-area { 
            background: transparent !important; padding: 0 !important; 
            height: 100vh !important; width: 100vw !important; 
            display: flex; align-items: center; justify-content: center; 
        }
        body.is-embedded #main-canvas { height: 100vh !important; width: 100vw !important; padding: 0 !important; }
        
        /* ESTADO DE CARGA DE ARCHIVO */
        .upload-status { font-size: 10px; font-weight: bold; margin-top: 5px; color: var(--primary); display: none; }
        
        .switch { position: relative; display: inline-block; width: 44px; height: 24px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider-toggle { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #334155; transition: .4s; border-radius: 34px; }
        .slider-toggle:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider-toggle { background-color: var(--primary); }
        input:checked + .slider-toggle:before { transform: translateX(20px); }
    </style>
</head>
<body id="main-body" class="bg-slate-200 text-slate-900 h-screen overflow-hidden flex is-loading">

    <div id="loader" class="fixed inset-0 flex flex-col items-center justify-center text-white pointer-events-none opacity-0">
        <div class="w-20 h-20 border-4 border-slate-800 border-t-cyan-400 rounded-full animate-spin mb-6"></div>
        <p class="text-[12px] font-black tracking-[0.5em] uppercase opacity-40">Cargando Estudio...</p>
    </div>

    <!-- PANEL DE CONTROL -->
    <aside id="editor-sidebar" class="w-[440px] bg-white border-r border-slate-300 flex flex-col h-full z-[100] shadow-2xl">
        <div class="p-8 border-b border-slate-200 bg-slate-50/50">
            <h1 class="text-2xl font-black text-cyan-600 uppercase tracking-tighter leading-none">Audio Studio Pro</h1>
            <p class="text-[10px] text-slate-400 font-bold uppercase tracking-widest mt-1">Architect Design Suite v5</p>
        </div>

        <div class="flex bg-slate-100 border-b border-slate-200">
            <button onclick="window.showTab('estilo')" id="btn-estilo" class="flex-1 py-5 text-[11px] font-black uppercase border-b-2 border-cyan-500 text-cyan-600 transition-all">Estilo</button>
            <button onclick="window.showTab('contenido')" id="btn-contenido" class="flex-1 py-5 text-[11px] font-black uppercase border-b-2 border-transparent text-slate-400 transition-all">Contenido</button>
            <button onclick="window.showTab('presets')" id="btn-presets" class="flex-1 py-5 text-[11px] font-black uppercase border-b-2 border-transparent text-slate-400 transition-all">Presets</button>
        </div>

        <div class="flex-1 overflow-y-auto p-8 space-y-12">
            <!-- TAB: ESTILO -->
            <div id="tab-estilo" class="sidebar-tab-content active space-y-10">
                <!-- Secciones de estilo (Id√©nticas para no perder dise√±o) -->
                <section class="space-y-5">
                    <label class="text-[11px] font-black text-slate-500 uppercase tracking-widest flex items-center gap-2"><span class="w-6 h-6 bg-cyan-100 text-cyan-600 rounded-lg flex items-center justify-center text-[10px]">1</span> Estructura</label>
                    <div class="space-y-6 p-6 bg-slate-50 rounded-[2rem] border border-slate-200">
                        <div class="space-y-3"><div class="flex justify-between text-[11px] font-black"><span>Ancho</span><span id="val-w" class="text-cyan-600">460px</span></div><input type="range" id="cfg-w" min="200" max="1000" value="460" oninput="window.syncUI()" class="w-full"></div>
                        <div class="space-y-3"><div class="flex justify-between text-[11px] font-black"><span>Alto</span><span id="val-h" class="text-cyan-600">150px</span></div><input type="range" id="cfg-h" min="80" max="800" value="150" oninput="window.syncUI()" class="w-full"></div>
                        <div class="space-y-3"><div class="flex justify-between text-[11px] font-black"><span>Redondeo</span><span id="val-rd-main" class="text-cyan-600">24px</span></div><input type="range" id="cfg-rd-main" min="0" max="400" value="24" oninput="window.syncUI()" class="w-full"></div>
                        <div class="flex items-center justify-between pt-4 border-t border-slate-200"><span class="text-[12px] font-black text-slate-700">Efecto Mica</span><label class="switch"><input type="checkbox" id="cfg-show-mica" checked onchange="window.syncUI()"><span class="slider-toggle"></span></label></div>
                        <div class="grid grid-cols-2 gap-6 pt-2">
                            <div class="space-y-2"><span class="text-[9px] font-black text-slate-500 uppercase">Fondo</span><input type="color" id="cfg-bg-color" value="#0f172a" oninput="window.syncUI()" class="w-full h-11 rounded-2xl border-none cursor-pointer"></div>
                            <div class="space-y-2"><span class="text-[9px] font-black text-slate-500 uppercase">Opacidad</span><input type="range" id="cfg-op-val" min="0" max="100" value="70" oninput="window.syncUI()" class="w-full mt-2"></div>
                        </div>
                    </div>
                </section>
                <!-- Bot√≥n, Texto, Progreso (Omitido por brevedad pero presente en l√≥gica) -->
                 <section class="space-y-5">
                    <label class="text-[11px] font-black text-slate-500 uppercase tracking-widest flex items-center gap-2"><span class="w-6 h-6 bg-cyan-100 text-cyan-600 rounded-lg flex items-center justify-center text-[10px]">2</span> Bot√≥n</label>
                    <div class="space-y-6 p-6 bg-slate-50 rounded-[2rem] border border-slate-200">
                        <div class="grid grid-cols-3 gap-4">
                            <div class="space-y-2 text-center"><span class="text-[8px] font-black text-slate-500 uppercase">Tri√°ngulo</span><input type="color" id="cfg-btn-tri" value="#ffffff" oninput="window.syncUI()" class="w-full h-9 rounded-xl border-none cursor-pointer shadow-sm"></div>
                            <div class="space-y-2 text-center"><span class="text-[8px] font-black text-slate-500 uppercase">Fondo</span><input type="color" id="cfg-btn-bg" value="#00c4cc" oninput="window.syncUI()" class="w-full h-9 rounded-xl border-none cursor-pointer shadow-sm"></div>
                            <div class="space-y-2 text-center"><span class="text-[8px] font-black text-slate-500 uppercase">Anillo</span><input type="color" id="cfg-btn-contour" value="#ffffff" oninput="window.syncUI()" class="w-full h-9 rounded-xl border-none cursor-pointer shadow-sm"></div>
                        </div>
                        <div class="flex items-center justify-between"><span class="text-[12px] font-black text-slate-700">Mostrar Anillo</span><label class="switch"><input type="checkbox" id="cfg-show-contour" checked onchange="window.syncUI()"><span class="slider-toggle"></span></label></div>
                        <div class="space-y-3"><div class="flex justify-between text-[11px] font-black"><span>Redondeo</span><span id="val-rd-btn" class="text-cyan-600">100%</span></div><input type="range" id="cfg-rd-btn" min="0" max="100" value="100" oninput="window.syncUI()" class="w-full"></div>
                    </div>
                </section>
                <section class="space-y-5">
                    <label class="text-[11px] font-black text-slate-500 uppercase tracking-widest flex items-center gap-2"><span class="w-6 h-6 bg-cyan-100 text-cyan-600 rounded-lg flex items-center justify-center text-[10px]">3</span> Texto</label>
                    <div class="space-y-6 p-6 bg-slate-50 rounded-[2rem] border border-slate-200 shadow-sm">
                        <div class="space-y-4">
                            <div class="space-y-2"><span class="text-[9px] font-black text-slate-500 uppercase">Fuente</span><select id="cfg-font-type" onchange="window.syncUI()" class="w-full p-4 bg-white border rounded-2xl text-xs font-black shadow-sm outline-none"><option value="font-sans">Sans Serif</option><option value="font-serif">Serif</option><option value="font-mono">Mono</option><option value="font-impact">Impact</option></select></div>
                            <div class="space-y-2"><span class="text-[9px] font-black text-slate-500 uppercase">Tiempo</span><select id="cfg-font-prog" onchange="window.syncUI()" class="w-full p-4 bg-white border rounded-2xl text-xs font-black shadow-sm outline-none"><option value="font-mono">Mono</option><option value="font-sans">Sans</option><option value="font-impact">Impact</option></select></div>
                        </div>
                        <div class="grid grid-cols-2 gap-4"><div class="space-y-2 text-center"><span class="text-[8px] font-black text-slate-500 uppercase">T√≠tulo</span><input type="color" id="cfg-text-col" value="#ffffff" oninput="window.syncUI()" class="w-full h-9 rounded-xl border-none cursor-pointer"></div><div class="space-y-2 text-center"><span class="text-[8px] font-black text-slate-500 uppercase">Subt√≠tulo</span><input type="color" id="cfg-sub-col" value="#94a3b8" oninput="window.syncUI()" class="w-full h-9 rounded-xl border-none cursor-pointer"></div></div>
                        <div class="space-y-2"><span class="text-[9px] font-black text-slate-500 uppercase">Crono</span><input type="color" id="cfg-prog-text-col" value="#ffffff" oninput="window.syncUI()" class="w-full h-11 rounded-2xl border-none cursor-pointer"></div>
                    </div>
                </section>
                <section class="space-y-5">
                    <label class="text-[11px] font-black text-slate-500 uppercase tracking-widest flex items-center gap-2"><span class="w-6 h-6 bg-cyan-100 text-cyan-600 rounded-lg flex items-center justify-center text-[10px]">4</span> Progreso</label>
                    <div class="space-y-6 p-6 bg-slate-50 rounded-[2rem] border border-slate-200 shadow-sm">
                        <div class="grid grid-cols-3 gap-3"><button id="btn-prog-bar" onclick="window.setProgStyle('bar')" class="py-3 bg-cyan-600 text-white border rounded-2xl text-[10px] font-black uppercase shadow-sm">Barra</button><button id="btn-prog-wave" onclick="window.setProgStyle('wave')" class="py-3 bg-white text-slate-900 border rounded-2xl text-[10px] font-black uppercase shadow-sm">Onda</button><button id="btn-prog-spect" onclick="window.setProgStyle('spect')" class="py-3 bg-white text-slate-900 border rounded-2xl text-[10px] font-black uppercase shadow-sm">Espectro</button></div>
                        <div class="grid grid-cols-2 gap-6"><div class="space-y-2"><span class="text-[9px] font-black text-slate-500 uppercase">Carga</span><input type="color" id="cfg-bar-acc" value="#00c4cc" oninput="window.syncUI()" class="w-full h-10 rounded-xl border-none cursor-pointer shadow-sm"></div><div class="space-y-2"><span class="text-[9px] font-black text-slate-500 uppercase">Grosor</span><input type="range" id="cfg-bar-h" min="2" max="35" value="8" oninput="window.syncUI()" class="w-full mt-2"></div></div>
                    </div>
                </section>
            </div>

            <!-- TAB: CONTENIDO (MODIFICADO PARA SUBIDA) -->
            <div id="tab-contenido" class="sidebar-tab-content space-y-6">
                <div class="space-y-3">
                    <label class="text-[11px] font-black text-slate-400 uppercase tracking-widest">Fuente de Audio</label>
                    
                    <!-- INPUT DE ARCHIVO (NUEVO) -->
                    <div class="relative group">
                        <input type="file" id="cfg-audio-file" accept="audio/*" onchange="window.uploadAudio(this)" class="hidden">
                        <label for="cfg-audio-file" class="flex items-center justify-center w-full p-5 bg-slate-50 border-2 border-dashed border-slate-300 rounded-3xl text-xs font-black text-slate-500 cursor-pointer hover:border-cyan-500 hover:text-cyan-600 transition-all gap-2">
                            <span>‚òÅÔ∏è</span> Subir Archivo (MP3/WAV)
                        </label>
                    </div>
                    <div id="upload-msg" class="upload-status text-center">Subiendo...</div>

                    <div class="relative">
                        <div class="absolute inset-0 flex items-center"><div class="w-full border-t border-slate-200"></div></div>
                        <div class="relative flex justify-center text-xs uppercase"><span class="bg-white px-2 text-slate-400 font-black text-[9px]">O pegar enlace</span></div>
                    </div>

                    <input type="text" id="cfg-audio-url" placeholder="https://..." onchange="window.validateAudioUrl(this)" class="w-full p-5 bg-slate-50 border rounded-3xl text-xs font-black shadow-inner outline-none">
                </div>
                <div class="space-y-5">
                    <label class="text-[11px] font-black text-slate-400 uppercase tracking-widest">Metadatos</label>
                    <input type="text" id="cfg-track-title" value="An√°lisis de Frecuencia" oninput="window.syncUI()" class="w-full p-5 bg-slate-50 border rounded-3xl text-xs font-black outline-none">
                    <input type="text" id="cfg-track-artist" value="Audio Studio Pro v4" oninput="window.syncUI()" class="w-full p-5 bg-slate-50 border rounded-3xl text-xs font-bold outline-none">
                </div>
            </div>
            
            <!-- TAB: PRESETS -->
             <div id="tab-presets" class="sidebar-tab-content space-y-4">
                <button onclick="window.applyPreset('cyber')" class="w-full p-5 bg-black text-cyan-400 rounded-3xl text-[11px] font-black uppercase text-left border border-cyan-500/40 shadow-xl">Cyber Neon Glass</button>
                <button onclick="window.applyPreset('executive')" class="w-full p-5 bg-slate-900 text-white rounded-3xl text-[11px] font-black uppercase text-left border border-white/10 shadow-2xl">Executive Mica Dark</button>
                <button onclick="window.applyPreset('minimal')" class="w-full p-5 bg-white text-slate-900 rounded-3xl text-[11px] font-black uppercase text-left border border-slate-200 shadow-xl">Minimalist Cloud</button>
                <button onclick="window.applyPreset('classic')" class="w-full p-5 bg-amber-50 text-amber-900 rounded-3xl text-[11px] font-black uppercase text-left border border-amber-200 shadow-md">Vinyl Gold Edition</button>
                <button onclick="window.applyPreset('deepspace')" class="w-full p-5 bg-[#020617] text-indigo-400 rounded-3xl text-[11px] font-black uppercase text-left border border-indigo-500/30 shadow-2xl">Deep Space Studio</button>
            </div>
        </div>

        <div class="p-8 bg-white border-t border-slate-100 space-y-4">
            <button onclick="window.downloadPreview()" class="w-full bg-slate-800 hover:bg-slate-900 text-white font-black py-4 rounded-[1.5rem] shadow-lg transition-all text-[10px] uppercase tracking-widest flex items-center justify-center gap-2">
                <span>üì∏</span> Descargar Portada
            </button>
            <button onclick="window.publish()" class="w-full bg-cyan-600 hover:bg-cyan-700 text-white font-black py-5 rounded-[2.5rem] shadow-2xl transition-all active:scale-95 text-xs uppercase tracking-widest">
                Publicar para Canva
            </button>
        </div>
    </aside>

    <!-- √ÅREA DE DISE√ëO (CANVAS) -->
    <main id="main-canvas" class="flex-1 relative canvas-area flex items-center justify-center p-16 overflow-hidden">
        <div id="workspace-label" class="absolute top-10 text-[11px] font-black text-slate-500 uppercase tracking-[1em] opacity-30 pointer-events-none">Architect Workspace v4</div>
        
        <div id="player-master" class="relative overflow-hidden transition-all duration-300 shadow-2xl">
            <div id="spect-layer" class="absolute inset-0 opacity-40 z-0 pointer-events-none hidden">
                <div class="w-full h-full"><canvas id="audioChart"></canvas></div>
            </div>

            <div id="elements-container" class="relative z-10 w-full h-full">
                <div id="drag-play" class="draggable" style="top: 35px; left: 35px;">
                    <button onclick="window.toggleAudio()" id="play-btn-main" class="w-20 h-20 shadow-2xl">
                        <div id="play-btn-contour"></div>
                        <svg width="34" height="34" viewBox="0 0 24 24" fill="currentColor"><path id="path-icon" d="M8 5V19L19 12L8 5Z" /></svg>
                    </button>
                </div>
                <div id="drag-text" class="draggable" style="top: 35px; left: 140px; width: 280px;">
                    <h3 id="ui-title" class="text-2xl font-black leading-none truncate mb-1 text-white">An√°lisis de Frecuencia</h3>
                    <p id="ui-subtitle" class="text-[11px] font-black opacity-60 uppercase tracking-widest truncate text-slate-400">Audio Studio Pro v4</p>
                </div>
                <div id="drag-progress" class="draggable" style="top: 100px; left: 140px; width: 280px;">
                    <div id="progress-ui" class="w-full bg-white/15 rounded-full overflow-hidden relative">
                        <div id="progress-fill" class="h-full transition-all duration-300" style="width: 0%"></div>
                        <div id="progress-wave" class="absolute inset-0 hidden"><div class="h-full w-full" id="wave-pulse-overlay"></div></div>
                    </div>
                    <div id="timer-group" class="flex justify-between mt-2 text-[11px] font-black opacity-90 tracking-tighter text-white">
                        <span id="ui-now">00:00</span>
                        <span id="ui-total">00:00</span>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- MODAL -->
    <div id="modal-export" class="fixed inset-0 bg-slate-900/98 backdrop-blur-3xl z-[2000] hidden items-center justify-center p-8 text-center">
        <div class="bg-white rounded-[3.5rem] p-12 max-w-sm w-full shadow-2xl border border-slate-100">
            <h2 class="text-2xl font-black mb-3 tracking-tighter text-slate-800">Dise√±o Sincronizado</h2>
            <p class="text-[11px] text-slate-500 mb-10 font-black uppercase">Copia este link para la herramienta Incrustar en Canva.</p>
            <div id="export-url" class="bg-slate-50 p-6 rounded-3xl text-[10px] font-mono break-all border border-slate-200 mb-10 text-left text-slate-600 shadow-sm overflow-hidden"></div>
            <button onclick="window.copyAndFinish()" class="w-full bg-slate-900 text-white font-black py-5 rounded-[2.5rem] hover:bg-black transition-all shadow-xl">COPIAR Y FINALIZAR</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js';
        import { getFirestore, doc, setDoc, getDoc } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';
        import { getAuth, signInAnonymously, onAuthStateChanged, setPersistence, inMemoryPersistence } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';
        // IMPORTANTE: M√≥dulo de Storage para subir archivos
        import { getStorage, ref, uploadBytes, getDownloadURL } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js';

        let activeProgStyle = 'bar';
        let isPlaying = false;
        const audio = new Audio();
        audio.preload = "auto";
        audio.crossOrigin = "anonymous";
        
        let currentAuth = null;
        let db, auth, storage;
        let chart; 

        const urlParams = new URLSearchParams(window.location.search);
        const savedId = urlParams.get('id');
        
        // --- LOGICA DE ESTADO (Cargando vs Listo) ---
        if (savedId) {
            document.body.classList.add('is-embedded');
            document.getElementById('loader').style.opacity = '1';
        } else {
             document.getElementById('loader').style.display = 'none';
             document.body.classList.remove('is-loading');
             document.body.classList.add('is-ready');
        }

        // --- SUBIDA DE ARCHIVOS (SOLUCI√ìN VOCAROO) ---
        window.uploadAudio = async (input) => {
            const file = input.files[0];
            if (!file) return;

            const status = document.getElementById('upload-msg');
            status.innerText = "Subiendo archivo...";
            status.style.display = 'block';

            try {
                // Crear referencia √∫nica para el archivo
                const storageRef = ref(storage, 'audio/' + Date.now() + '_' + file.name);
                await uploadBytes(storageRef, file);
                const url = await getDownloadURL(storageRef);
                
                // Poner URL en el input y guardar
                document.getElementById('cfg-audio-url').value = url;
                status.innerText = "‚úÖ Archivo listo";
                status.style.color = "#10b981"; // Verde
                
                // Cargar audio inmediatamente
                window.toggleAudio();
                
            } catch (error) {
                console.error("Error subida:", error);
                status.innerText = "Error al subir. Habilita Storage en Firebase.";
                status.style.color = "#ef4444"; // Rojo
            }
        };

        window.downloadPreview = () => {
            document.fonts.ready.then(() => {
                const element = document.getElementById("player-master");
                html2canvas(element, {
                    backgroundColor: null, scale: 3, scrollY: -window.scrollY, logging: false,
                    onclone: (clonedDoc) => {
                        const titles = clonedDoc.querySelectorAll('#ui-title, #ui-subtitle, #ui-now, #ui-total');
                        titles.forEach(el => {
                            el.style.overflow = 'visible'; el.style.whiteSpace = 'normal';
                            el.style.lineHeight = '1.3'; el.style.paddingBottom = '10px'; el.style.marginBottom = '-10px';
                        });
                    }
                }).then(canvas => {
                    const link = document.createElement('a'); link.download = 'preview.png'; link.href = canvas.toDataURL("image/png"); link.click();
                    alert("‚úÖ Imagen descargada. Sube 'preview.png' a GitHub.");
                });
            });
        };

        window.validateAudioUrl = (input) => {
            let url = input.value.trim();
            if (url.includes('drive.google.com')) {
                const match = url.match(/\/d\/(.+?)\//) || url.match(/id=(.+?)(&|$)/);
                if (match && match[1]) { url = `https://docs.google.com/uc?export=download&id=${match[1]}`; input.value = url; }
            }
            if (url.includes('dropbox.com') && url.includes('dl=0')) { url = url.replace('dl=0', 'dl=1'); input.value = url; }
            window.syncUI();
        };

        window.syncUI = () => {
            const get = (id) => document.getElementById(id);
            const master = get('player-master');
            if (!master) return;
            const w = get('cfg-w').value; const h = get('cfg-h').value; const rd = get('cfg-rd-main').value; const op = get('cfg-op-val').value; const bg = get('cfg-bg-color').value; const showMica = get('cfg-show-mica').checked;
            master.style.width = w + 'px'; master.style.height = h + 'px'; master.style.borderRadius = rd + 'px'; master.style.backgroundColor = hexToRgba(bg, op / 100); master.classList.toggle('mica-layer', showMica);
            if(get('val-w')) get('val-w').innerText = w + 'px'; if(get('val-h')) get('val-h').innerText = h + 'px'; if(get('val-rd-main')) get('val-rd-main').innerText = rd + 'px';

            const btn = get('play-btn-main'); const contour = get('play-btn-contour');
            if (btn && contour) {
                btn.style.color = get('cfg-btn-tri').value; btn.style.backgroundColor = get('cfg-btn-bg').value; btn.style.borderRadius = get('cfg-rd-btn').value + '%';
                const showCont = get('cfg-show-contour').checked;
                contour.style.setProperty('--contour-color', showCont ? get('cfg-btn-contour').value : 'transparent'); contour.style.borderRadius = get('cfg-rd-btn').value + '%';
            }
            const textMod = get('drag-text'); const timerGrp = get('timer-group');
            if (textMod && timerGrp) {
                textMod.className = `draggable ${get('cfg-font-type').value}`;
                timerGrp.className = `flex justify-between mt-2 text-[11px] font-black opacity-90 tracking-tighter ${get('cfg-font-prog').value}`;
                timerGrp.style.color = get('cfg-prog-text-col').value;
                get('ui-title').style.color = get('cfg-text-col').value; get('ui-title').innerText = get('cfg-track-title').value;
                get('ui-subtitle').style.color = get('cfg-sub-col').value; get('ui-subtitle').innerText = get('cfg-track-artist').value;
            }
            const progFill = get('progress-fill');
            if (progFill) {
                const acc = get('cfg-bar-acc').value; get('progress-ui').style.height = get('cfg-bar-h').value + 'px'; progFill.style.backgroundColor = acc;
                const wave = get('progress-wave'); const spect = get('spect-layer');
                if (activeProgStyle === 'wave') { wave.classList.remove('hidden'); document.getElementById('wave-pulse-overlay').style.backgroundColor = acc; document.getElementById('wave-pulse-overlay').classList.add('wave-active'); spect.classList.add('hidden'); }
                else if (activeProgStyle === 'spect') { wave.classList.add('hidden'); spect.classList.remove('hidden'); }
                else { wave.classList.add('hidden'); spect.classList.add('hidden'); }
            }
        };

        window.showTab = (n) => {
            document.querySelectorAll('.sidebar-tab-content').forEach(c => c.classList.remove('active'));
            ['estilo', 'contenido', 'presets'].forEach(t => { const btn = document.getElementById('btn-'+t); if (btn) { btn.classList.remove('border-cyan-500', 'text-cyan-600'); btn.classList.add('border-transparent', 'text-slate-400'); } });
            const activeTab = document.getElementById('tab-'+n); const activeBtn = document.getElementById('btn-'+n);
            if (activeTab) activeTab.classList.add('active'); if (activeBtn) { activeBtn.classList.remove('border-transparent', 'text-slate-400'); activeBtn.classList.add('border-cyan-500', 'text-cyan-600'); }
        };

        window.setProgStyle = (s) => {
            activeProgStyle = s;
            ['bar', 'wave', 'spect'].forEach(mode => { const btn = document.getElementById('btn-prog-' + mode); if (btn) { if (mode === s) { btn.classList.remove('bg-white', 'text-slate-900'); btn.classList.add('bg-cyan-600', 'text-white'); } else { btn.classList.add('bg-white', 'text-slate-900'); btn.classList.remove('bg-cyan-600', 'text-white'); } } });
            window.syncUI();
        };

        window.toggleAudio = () => {
            const url = document.getElementById('cfg-audio-url').value;
            if (!url) return;
            if (audio.src !== url && audio.src !== new URL(url, window.location.href).href) { audio.src = url; audio.load(); }

            const path = document.getElementById('path-icon');
            if (audio.paused) {
                audio.play().then(() => {
                    isPlaying = true; path.setAttribute('d', 'M6 19h4V5H6v14zm8-14v14h4V5h-4z'); renderLoop();
                }).catch(e => console.error(e));
            } else { audio.pause(); isPlaying = false; path.setAttribute('d', 'M8 5V19L19 12L8 5Z'); }
        };

        window.publish = async () => {
            if (!currentAuth) return;
            const id = Math.random().toString(36).substring(2, 10);
            const data = {
                w: document.getElementById('cfg-w').value, h: document.getElementById('cfg-h').value, rdMain: document.getElementById('cfg-rd-main').value, op: document.getElementById('cfg-op-val').value, bg: document.getElementById('cfg-bg-color').value,
                title: encodeURIComponent(document.getElementById('cfg-track-title').value), artist: encodeURIComponent(document.getElementById('cfg-track-artist').value), url: document.getElementById('cfg-audio-url').value,
                btnTri: document.getElementById('cfg-btn-tri').value, btnBg: document.getElementById('cfg-btn-bg').value, btnContour: document.getElementById('cfg-btn-contour').value, showContour: document.getElementById('cfg-show-contour').checked, rdBtn: document.getElementById('cfg-rd-btn').value,
                fontType: document.getElementById('cfg-font-type').value, fontProg: document.getElementById('cfg-font-prog').value, textCol: document.getElementById('cfg-text-col').value, subCol: document.getElementById('cfg-sub-col').value, progTextCol: document.getElementById('cfg-prog-text-col').value,
                barAcc: document.getElementById('cfg-bar-acc').value, barH: document.getElementById('cfg-bar-h').value, showMica: document.getElementById('cfg-show-mica').checked, progStyle: activeProgStyle,
                m1: { x: parseFloat(document.getElementById('drag-play').style.left), y: parseFloat(document.getElementById('drag-play').style.top) },
                m2: { x: parseFloat(document.getElementById('drag-text').style.left), y: parseFloat(document.getElementById('drag-text').style.top) },
                m3: { x: parseFloat(document.getElementById('drag-progress').style.left), y: parseFloat(document.getElementById('drag-progress').style.top) }
            };
            try {
                const appId = 'audio-studio-pro'; await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'designs', id), data);
                // GENERAR URL LIMPIA
                const baseUrl = "https://reproductor-canva.vercel.app";
                const url = `${baseUrl}/?id=${id}`;
                document.getElementById('export-url').innerText = url; document.getElementById('modal-export').classList.replace('hidden', 'flex');
            } catch(e) { console.error("Error guardando:", e); }
        };

        window.copyAndFinish = () => { navigator.clipboard.writeText(document.getElementById('export-url').innerText); document.getElementById('modal-export').classList.replace('flex', 'hidden'); };

        window.applyPreset = (p) => {
            const g = (id) => document.getElementById(id);
            if (p === 'cyber') { g('cfg-bg-color').value = '#000000'; g('cfg-op-val').value = 85; g('cfg-text-col').value = '#00f2ff'; g('cfg-bar-acc').value = '#ff00ff'; g('cfg-font-type').value = 'font-mono'; window.setProgStyle('spect'); }
            else if (p === 'executive') { g('cfg-bg-color').value = '#0f172a'; g('cfg-op-val').value = 60; g('cfg-text-col').value = '#ffffff'; g('cfg-bar-acc').value = '#00c4cc'; g('cfg-font-type').value = 'font-sans'; window.setProgStyle('bar'); }
            else if (p === 'minimal') { g('cfg-bg-color').value = '#ffffff'; g('cfg-op-val').value = 100; g('cfg-text-col').value = '#1e293b'; g('cfg-bar-acc').value = '#3b82f6'; g('cfg-font-type').value = 'font-sans'; window.setProgStyle('wave'); }
            else if (p === 'classic') { g('cfg-bg-color').value = '#fef3c7'; g('cfg-op-val').value = 100; g('cfg-text-col').value = '#451a03'; g('cfg-bar-acc').value = '#b45309'; g('cfg-font-type').value = 'font-serif'; window.setProgStyle('bar'); }
            else if (p === 'deepspace') { g('cfg-bg-color').value = '#020617'; g('cfg-op-val').value = 40; g('cfg-text-col').value = '#818cf8'; g('cfg-bar-acc').value = '#6366f1'; g('cfg-font-type').value = 'font-mono'; window.setProgStyle('spect'); }
            window.syncUI();
        };

        function hexToRgba(hex, a) { let r = parseInt(hex.slice(1, 3), 16), g = parseInt(hex.slice(3, 5), 16), b = parseInt(hex.slice(5, 7), 16); return `rgba(${r}, ${g}, ${b}, ${a})`; }

        function renderLoop() {
            if (!isPlaying) return;
            if (chart && activeProgStyle === 'spect') { chart.data.datasets[0].data = chart.data.datasets[0].data.map(() => Math.random() * 100); chart.update(); }
            const pct = (audio.currentTime / audio.duration) * 100; const fill = document.getElementById('progress-fill'); if(fill) fill.style.width = pct + '%';
            const f = (t) => { if (isNaN(t)) return "00:00"; const m = Math.floor(t/60), s = Math.floor(t%60); return `${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`; };
            const uiNow = document.getElementById('ui-now'); const uiTotal = document.getElementById('ui-total'); if(uiNow) uiNow.innerText = f(audio.currentTime); if(uiTotal) uiTotal.innerText = f(audio.duration);
            requestAnimationFrame(renderLoop);
        }

        const firebaseConfig = { apiKey: "AIzaSyBWelUwvZAdKlS4ks7MlL-ALP4f3A0ok88", authDomain: "audiostudiopro-a876a.firebaseapp.com", projectId: "audiostudiopro-a876a", storageBucket: "audiostudiopro-a876a.firebasestorage.app", messagingSenderId: "618218270805", appId: "1:618218270805:web:7c4e63066a770cf095e4dc", measurementId: "G-EE97PW6QZL" };
        const fbApp = initializeApp(firebaseConfig); auth = getAuth(fbApp); db = getFirestore(fbApp); storage = getStorage(fbApp);
        setPersistence(auth, inMemoryPersistence).then(() => signInAnonymously(auth)).catch(console.error);

        onAuthStateChanged(auth, (u) => {
            currentAuth = u;
            if (u && savedId) {
                getDoc(doc(db, 'artifacts', 'audio-studio-pro', 'public', 'data', 'designs', savedId)).then(snap => {
                    if (snap.exists()) {
                        const d = snap.data(); const g = (id) => document.getElementById(id);
                        g('cfg-w').value = d.w; g('cfg-h').value = d.h; g('cfg-bg-color').value = d.bg; g('cfg-op-val').value = d.op; g('cfg-rd-main').value = d.rdMain || 24;
                        g('cfg-audio-url').value = d.url || ''; g('cfg-track-title').value = decodeURIComponent(d.title || ''); g('cfg-track-artist').value = decodeURIComponent(d.artist || '');
                        if (d.btnBg) g('cfg-btn-bg').value = d.btnBg; if (d.btnTri) g('cfg-btn-tri').value = d.btnTri; if (d.btnContour) g('cfg-btn-contour').value = d.btnContour;
                        if (d.rdBtn) g('cfg-rd-btn').value = d.rdBtn; if (d.fontType) g('cfg-font-type').value = d.fontType; if (d.fontProg) g('cfg-font-prog').value = d.fontProg;
                        if (d.textCol) g('cfg-text-col').value = d.textCol; if (d.subCol) g('cfg-sub-col').value = d.subCol; if (d.progTextCol) g('cfg-prog-text-col').value = d.progTextCol;
                        if (d.barAcc) g('cfg-bar-acc').value = d.barAcc; if (d.barH) g('cfg-bar-h').value = d.barH;
                        g('cfg-show-contour').checked = d.showContour !== undefined ? d.showContour : true; g('cfg-show-mica').checked = d.showMica !== undefined ? d.showMica : true;
                        if(d.m1) { g('drag-play').style.left = d.m1.x + '%'; g('drag-play').style.top = d.m1.y + '%'; }
                        if(d.m2) { g('drag-text').style.left = d.m2.x + '%'; g('drag-text').style.top = d.m2.y + '%'; }
                        if(d.m3) { g('drag-progress').style.left = d.m3.x + '%'; g('drag-progress').style.top = d.m3.y + '%'; }
                        window.setProgStyle(d.progStyle || 'bar'); window.syncUI();
                    }
                    // MOSTRAR INTERFAZ SOLO CUANDO TODO EST√Å LISTO
                    const l = document.getElementById('loader');
                    if (l) {
                        l.style.opacity = '0';
                        setTimeout(() => {
                            l.style.display = 'none';
                            document.body.classList.remove('is-loading');
                            document.body.classList.add('is-ready');
                        }, 500);
                    }
                }).catch(e => { console.error(e); document.getElementById('loader').style.display = 'none'; });
            } else if (!savedId) document.getElementById('loader').style.display = 'none';
        });

        window.onload = () => { const c = document.getElementById('audioChart'); if(c) { const ctx = c.getContext('2d'); chart = new Chart(ctx, { type: 'bar', data: { labels: Array(22).fill(''), datasets: [{ data: Array(22).fill(0), backgroundColor: '#00c4cc', borderRadius: 20 }] }, options: { responsive: true, maintainAspectRatio: false, scales: { y: { display: false, min:0, max:100 }, x: { display: false } }, plugins: { legend: false }, animation: false } }); } window.syncUI(); };

        let activeMod = null;
        if (!savedId) {
            document.addEventListener('mousedown', (e) => {
                const t = e.target.closest('.draggable');
                if (t) { activeMod = t; const r = t.getBoundingClientRect(); activeMod._x = e.clientX - r.left; activeMod._y = e.clientY - r.top; }
            });
            document.addEventListener('mousemove', (e) => {
                if (activeMod) {
                    const p = document.getElementById('player-master').getBoundingClientRect();
                    let x = ((e.clientX - p.left - activeMod._x) / p.width) * 100;
                    let y = ((e.clientY - p.top - activeMod._y) / p.height) * 100;
                    activeMod.style.left = Math.max(0, Math.min(x, 90)) + '%';
                    activeMod.style.top = Math.max(0, Math.min(y, 85)) + '%';
                }
            });
            document.addEventListener('mouseup', () => activeMod = null);
        }
    </script>
</body>
</html>
